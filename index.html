<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Phishing Hunter Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #1a1a2e; }
        canvas { display: block; margin: 0 auto; }
    </style>
</head>
<body>
    <div id="game-container"></div>

    <script>
        // INICIALIZACI칍N DE TELEGRAM
        const tg = window.Telegram.WebApp;
        tg.expand(); // Expande la app a pantalla completa
        tg.ready();

        // BASE DE DATOS LOCAL: Aqu칤 puedes agregar o quitar correos para el juego
        const phishingEmails = [
            { sender: "Admin_PayPaI", text: "춰Cuenta bloqueada! Clic aqu칤", isPhishing: true },
            { sender: "Netflix_Info", text: "Tu suscripci칩n vence ma침ana", isPhishing: false },
            { sender: "MetaMask_Support", text: "Verifica tus 12 palabras", isPhishing: true },
            { sender: "Banco_Seguro", text: "Tienes una nueva transferencia", isPhishing: false },
            { sender: "Amazon_Gift", text: "Ganaste un iPhone 15", isPhishing: true },
            { sender: "Steam_Store", text: "Confirmaci칩n de compra: $0.00", isPhishing: false },
            { sender: "Google_Security", text: "Nuevo inicio de sesi칩n detectado", isPhishing: false },
            { sender: "Airdrop_Free", text: "Conecta tu wallet para reclamar", isPhishing: true }
        ];

        // CONFIGURACI칍N DEL MOTOR PHASER
        const config = {
            type: Phaser.AUTO,
            width: window.innerWidth,
            height: window.innerHeight,
            parent: 'game-container',
            backgroundColor: '#16213e',
            scene: { preload: preload, create: create }
        };

        const game = new Phaser.Game(config);
        
        // VARIABLES GLOBALES DE CONTROL
        let score = 0;          // Puntaje actual
        let lives = 3;          // Vidas restantes
        let scoreText;          // Objeto visual del texto de puntos
        let livesText;          // Objeto visual del texto de vidas
        let isGameOver = false; // Estado del juego

        // FUNCI칍N PRELOAD: Carga los recursos antes de iniciar
        function preload() {
            // Cargamos el icono del sobre desde una URL externa
            this.load.image('mail', 'https://cdn-icons-png.flaticon.com/512/561/561127.png');
        }

        // FUNCI칍N CREATE: Configura los elementos iniciales en pantalla
        function create() {
            isGameOver = false;
            score = 0;
            lives = 3;

            // Dibujamos el HUD (interfaz de usuario)
            scoreText = this.add.text(20, 20, 'TOKENS: 0', { fontSize: '24px', fill: '#00d2ff', fontWeight: 'bold' });
            livesText = this.add.text(window.innerWidth - 120, 20, '仇벒잺 ' + lives, { fontSize: '24px', fill: '#ff4d4d' });

            // Evento de tiempo: Ejecuta 'spawnEmail' cada 1.2 segundos infinitamente
            this.time.addEvent({
                delay: 1200,
                callback: spawnEmail,
                callbackScope: this,
                loop: true
            });
        }

        // FUNCI칍N SPAWNEMAIL: Crea y lanza los sobres desde la parte superior
        function spawnEmail() {
            if (isGameOver) return; // Si el juego termin칩, no salen m치s sobres

            const x = Phaser.Math.Between(80, window.innerWidth - 80); // Posici칩n X aleatoria
            const data = phishingEmails[Math.floor(Math.random() * phishingEmails.length)]; // Elige mensaje al azar
            
            // Creamos un contenedor para agrupar el rect치ngulo y los textos
            const emailContainer = this.add.container(x, -100);
            
            // Dibujamos el fondo del sobre (Rojo si es trampa, Verde si es real)
            const rect = this.add.rectangle(0, 0, 160, 90, data.isPhishing ? 0xff4d4d : 0x4dff88);
            rect.setStrokeStyle(3, 0xffffff); // Borde blanco
            
            // Agregamos icono, nombre del remitente y mensaje
            const sprite = this.add.sprite(0, -25, 'mail').setScale(0.06);
            const senderLabel = this.add.text(0, -5, data.sender, { fontSize: '12px', fill: '#000', fontWeight: 'bold' }).setOrigin(0.5);
            const messageLabel = this.add.text(0, 20, data.text, { fontSize: '10px', fill: '#333', wordWrap: { width: 140 }, align: 'center' }).setOrigin(0.5);

            emailContainer.add([rect, sprite, senderLabel, messageLabel]);
            emailContainer.setSize(160, 90);
            emailContainer.setInteractive(new Phaser.Geom.Rectangle(-80, -45, 160, 90), Phaser.Geom.Rectangle.Contains);

            // C츼LCULO DE DIFICULTAD: Aumenta la velocidad seg칰n el puntaje
            const levelBonus = Math.floor(score / 100) * 350; 
            const duration = Math.max(1100, 4500 - levelBonus); // No baja de 1.1 segundos

            // Movimiento hacia abajo con un "tween" (animaci칩n)
            this.tweens.add({
                targets: emailContainer,
                y: window.innerHeight + 150,
                duration: duration,
                onComplete: () => { emailContainer.destroy(); } // Se borra al salir de pantalla
            });

            // L칍GICA AL TOCAR EL SOBRE
            emailContainer.on('pointerdown', () => {
                if (isGameOver) return;

                if (data.isPhishing) {
                    // Si acierta (toca Phishing): Suma puntos y vibra suave
                    score += 10;
                    tg.HapticFeedback.impactOccurred('medium');
                } else {
                    // Si falla (toca correo real): Resta vida, vibra error y sacude c치mara
                    lives--;
                    tg.HapticFeedback.notificationOccurred('error');
                    this.cameras.main.shake(200, 0.01);
                    if (lives <= 0) gameOver.call(this); // Fin del juego
                }
                
                // Actualizamos textos en pantalla
                scoreText.setText('TOKENS: ' + score);
                livesText.setText('仇벒잺 ' + lives);
                emailContainer.destroy(); // Elimina el sobre tocado
            });
        }

        // FUNCI칍N GAMEOVER: Detiene el juego y muestra el men칰 final
        function gameOver() {
            isGameOver = true;
            // Fondo oscuro semitransparente
            this.add.rectangle(window.innerWidth/2, window.innerHeight/2, window.innerWidth, window.innerHeight, 0x000000, 0.85);
            
            // Mensajes finales
            this.add.text(window.innerWidth/2, window.innerHeight/2 - 100, 'FIN DEL JUEGO', { fontSize: '38px', fill: '#ff4d4d', fontWeight: 'bold' }).setOrigin(0.5);
            this.add.text(window.innerWidth/2, window.innerHeight/2 - 30, 'Puntaje: ' + score, { fontSize: '28px', fill: '#ffffff' }).setOrigin(0.5);
            
            // Bot칩n para enviar datos a Telegram
            const saveBtn = this.add.text(window.innerWidth/2, window.innerHeight/2 + 50, '游눯 RECLAMAR TOKENS', { 
                fontSize: '22px', fill: '#ffffff', backgroundColor: '#28a745', padding: 15
            }).setOrigin(0.5).setInteractive();

            saveBtn.on('pointerdown', () => { sendScoreToBot(score); });

            // Bot칩n para reiniciar la escena
            const restartBtn = this.add.text(window.innerWidth/2, window.innerHeight/2 + 130, '游댃 JUGAR DE NUEVO', { 
                fontSize: '18px', fill: '#aaaaaa', padding: 10 
            }).setOrigin(0.5).setInteractive();

            restartBtn.on('pointerdown', () => { this.scene.restart(); });
        }

        // FUNCI칍N SENDSCORETOBOT: Env칤a el puntaje final al chat de Telegram
        function sendScoreToBot(finalScore) {
            tg.showConfirm(`쮾uardar ${finalScore} tokens en tu cuenta?`, (confirm) => {
                if (confirm) {
                    // El comando SCORE:XX es lo que leer치 tu bot
                    tg.sendData(`SCORE:${finalScore}`);
                    tg.close(); // Cierra el juego despu칠s de enviar
                }
            });
        }
    </script>
</body>
</html>
